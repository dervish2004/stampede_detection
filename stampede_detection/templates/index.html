<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Crowd Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container { max-width: 1200px; }
    .card {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: none;
      border-radius: 0.75rem;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
      font-weight: 500;
      border-radius: 0.75rem 0.75rem 0 0;
    }
    .video-container video {
      width: 100%;
      border-radius: 0.5rem;
      background-color: #000;
    }
    .analytics-card .list-group-item strong {
        display: inline-block;
        width: 200px; /* Adjusted width for better alignment */
    }
    .chart-card {
        margin-top: 2rem;
    }
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }
    .badge {
        font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="text-center mb-5">
      <h1 class="display-5 fw-bold">Advanced Crowd Analytics ðŸ“ˆ</h1>
      <p class="lead text-muted">Detect crowd density, movement entropy, and potential risks in real-time.</p>
    </div>

    <div class="card mb-5">
      <div class="card-header"><i class="fas fa-upload me-2"></i>Step 1: Upload Video or Use a Live Stream</div>
      <div class="card-body p-4">
        <form action="/" method="POST" enctype="multipart/form-data" autocomplete="off">
          <div class="mb-3">
            <label for="video" class="form-label">Select a video file:</label>
            <input class="form-control" type="file" name="video" accept="video/*" />
            <div class="form-text">or</div>
            <label for="stream_url" class="form-label">Enter a CCTV stream URL (e.g., RTSP, HTTP):</label>
            <input class="form-control" type="text" name="stream_url" placeholder="rtsp://user:pass@ip:port/stream" />
          </div>
          <button type="submit" class="btn btn-primary btn-lg w-100"><i class="fas fa-cogs me-2"></i>Analyze Now</button>
        </form>
        {% if error %}
        <div class="alert alert-danger mt-3">{{ error }}</div>
        {% endif %}
      </div>
    </div>

    {% if output_video or is_live_stream %}
    <div class="results-section">
      <h2 class="text-center mb-4">Analysis Results</h2>
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="row g-4">
            {% if not is_live_stream %}
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><i class="fas fa-video me-2"></i>Input Video</div>
                <div class="card-body video-container">
                  <video controls muted><source src="{{ input_video }}?v={{ uuid }}" type="video/mp4" /></video>
                </div>
              </div>
            </div>
            {% endif %}
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><i class="fas fa-chart-line me-2"></i>Analyzed Output</div>
                <div class="card-body video-container">
                    {% if not is_live_stream %}
                        <video controls muted autoplay loop><source src="{{ output_video }}?v={{ uuid }}" type="video/mp4" /></video>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center" style="height: 100%; min-height: 200px;">
                            <p class="text-muted">Live stream analysis is in progress. The output video will not be displayed here.</p>
                        </div>
                    {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card h-100 analytics-card">
            <div class="card-header"><i class="fas fa-chart-pie me-2"></i>Summary Analytics</div>
            <div class="card-body d-flex flex-column">
              <ul class="list-group list-group-flush flex-grow-1">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <strong>Overall Threat Level:</strong>
                  <span class="badge {% if 'Critical' in overall_threat_level %} bg-danger {% elif 'High' in overall_threat_level %} bg-warning text-dark {% elif 'Moderate' in overall_threat_level %} bg-info text-dark {% else %} bg-success {% endif %} fs-6">{{ overall_threat_level }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center"><strong>Avg. Crowd Density (PPSM):</strong> <span>{{ avg_ppsm }}%</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center"><strong>Avg. Risk Score:</strong> <span>{{ avg_risk_score | default('N/A') }}</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center"><strong>PPSM Trend Alerts:</strong><span class="badge bg-warning text-dark rounded-pill">{{ ppsm_alerts }}</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center"><strong>Entropy Spike Alerts:</strong><span class="badge bg-danger rounded-pill">{{ entropy_alerts }}</span></li>
              </ul>
              {% if not is_live_stream %}
              <a href="{{ report_path }}" class="btn btn-success mt-3 w-100" download><i class="fas fa-download me-2"></i>Download Full CSV Report</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="card chart-card">
        <div class="card-header"><i class="fas fa-chart-area me-2"></i>Time-Series Data Visualization</div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-lg-6">
                    <h5 class="text-center">Crowd Density (PPSM) Over Time</h5>
                    <div class="chart-container">
                        <canvas id="ppsmChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6">
                    <h5 class="text-center">Movement Entropy Over Time</h5>
                    <div class="chart-container">
                        <canvas id="entropyChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-12 mt-4">
                    <h5 class="text-center">Calculated Risk Score Over Time</h5>
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>

    {% if chart_labels %}
    <script id="chart-data" type="application/json">
        {{ {
            "labels": chart_labels,
            "ppsmData": chart_ppsm_data,
            "entropyData": chart_entropy_data,
            "riskData": chart_stampede_data | default([])
        } | tojson | safe }}
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const dataScriptElement = document.getElementById('chart-data');
        if (dataScriptElement) {
            const chartData = JSON.parse(dataScriptElement.textContent);
            const { labels, ppsmData, entropyData, riskData } = chartData;

            const createChart = (ctx, label, data, borderColor, backgroundColor) => {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            borderColor: borderColor,
                            backgroundColor: backgroundColor,
                            borderWidth: 2,
                            pointRadius: 1,
                            tension: 0.4
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        maintainAspectRatio: false
                    }
                });
            };

            createChart(document.getElementById('ppsmChart'), 'PPSM %', ppsmData, 'rgba(54, 162, 235, 1)', 'rgba(54, 162, 235, 0.2)');
            createChart(document.getElementById('entropyChart'), 'Entropy', entropyData, 'rgba(255, 159, 64, 1)', 'rgba(255, 159, 64, 0.2)');
            createChart(document.getElementById('riskChart'), 'Risk Score', riskData, 'rgba(255, 99, 132, 1)', 'rgba(255, 99, 132, 0.2)');
        }
      });
    </script>
    {% endif %}
    {% endif %}
  </div>
</body>
</html>
